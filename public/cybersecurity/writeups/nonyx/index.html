<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Duma Labs</title>
    
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css">
	<link rel="stylesheet" href="../../../css/style.css">
        
</head>
<body class="d-flex flex-column min-vh-100"> 
    <header>
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container-fluid d-flex flex-column">
      <div class="d-flex justify-content-between align-items-center w-100 py-2">
        <button class="navbar-toggler d-lg-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavCollapse" aria-controls="navbarNavCollapse" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <a class="navbar-brand text-dark fw-bold mx-auto px-0" href="../../../">
          Duma Labs
        </a>

        <div class="d-lg-none" style="width: 48px;"></div> </div>

      <div class="collapse navbar-collapse justify-content-center" id="navbarNavCollapse">
        <ul class="navbar-nav">
          
            
              <li class="nav-item">
                <a class="nav-link text-dark" href="../../../about/">About Me</a>
              </li>
            
          
            
              <li class="nav-item">
                <a class="nav-link text-dark" href="../../../blog/">Blog</a>
              </li>
            
          
            
              <li class="nav-item">
                <a class="nav-link text-dark" href="../../../ttrpg/">TTRPG</a>
              </li>
            
          
            
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Cybersecurity
                </a>
                <ul class="dropdown-menu">
                  
                    <li><a class="dropdown-item text-dark" href="../../../cybersecurity/writeups/">Write-Ups</a></li>
                  
                </ul>
              </li>
            
          
            
              <li class="nav-item">
                <a class="nav-link text-dark" href="../../../photography/">Photography</a>
              </li>
            
          
        </ul>
      </div>
    </div>
  </nav>
</header>

    <main class="flex-grow-1"> 
	
<div class="container my-5">
    <h1 class="text-center">Nonyx</h1>
    <div>
        <h2 id="scenario">Scenario:</h2>
<p>Purify Black Energy 2 from Shadowbrook’s digital infrastructure by reverse-engineering the malware’s code.</p>
<hr>
<h2 id="process-of-investigation">Process of Investigation:</h2>
<p>When the investigation environment loads, there are a few files and directories already on the desktop. There were directories for the applications CyberChef and volatility, and files <code>readme.txt</code> file, and <code>BlackEnergy.vnem</code>.</p>
<p>The readme file was small, and only contained the text:</p>
<pre tabindex="0"><code class="language-code" data-lang="code">WinXPSP2x86 is the profile you must use.  
It is best to place the output of the vol2 commands to a .txt file for better readability.
</code></pre><p>Volatility was provided on the desktop of the investigation, so I started with running <code>volatility</code> and the <code>pslist</code> command, with the profile <code>WinXPSP2x86</code> as suggested by the readme file, against the image file, then saving the output to a text file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python vol.py --profile<span style="color:#f92672">=</span>WinXPSP2x86 -f /home/ubuntu/Desktop/BlackEnergy.vnem pslist &gt; processes.txt
</span></span></code></pre></div><p>This gave me a list of processes, with offsets, PIDs, etc, but it didn&rsquo;t show anything obvious that would answer the first question, Which process most likely contains injected code, providing its name, PID, and memory address?. There was more to do to get this answer.</p>
<p><img src="00_volpy_pslist.jpg" alt="alt"></p>
<p>I next ran the <code>malfind</code> command as part of <code>volatility</code> to get a view of any potential process injections.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python vol.py --profile<span style="color:#f92672">=</span>WinXPSP2x86 -f ~/Desktop/BlackEnergy.vnem malfind &gt; ~/Desktop/malfind.txt
</span></span></code></pre></div><p>The results display several processes, along with the PID and memory address, the header including addresses, and the HEX values, as well as some Assembly instructions. Reviewing the results, one in particular stands out. Process <code>svchost.exe</code> shows the HEX value <code>4d5a</code> in the header, which has the ASCII value <code>MZ</code>.</p>
<p><img src="01_malfind_svchost.jpg" alt="alt"></p>
<p>An executable file header, specifically .exe formats, can be identified my the MZ at the start of the header file, which I confirmed with <a href="https://www.fileformat.info/format/exe/corion-mz.htm">FileFormat.Info</a>. Other processes from .exe files do not contain this header, so this would indicate that this process is the victim of Portable Executable Injection.</p>
<p>With the process confirmed, I now ran the same <code>malfind</code> command again, but this time using the <code>-D</code> parameter, so that I could get a dump file of the processes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python vol.py --profile<span style="color:#f92672">=</span>WinXPSP2x86 -f ~/Desktop/BlackEnergy.vnem malfind -D ~/Desktop/malfind_dump
</span></span></code></pre></div><p>This gave me dump files from all the processes, so to answer question two, I looked for the dump file that had the memory address of the process in the name, in this case <code>process.0x80ff88d8.0xc30000.dmp</code>.</p>
<p><img src="02_process_dump.jpg" alt="alt"></p>
<p>Next, I wanted to get the strings output of the dump file, to look at identifying the filename path referenced. I pushed the output to a text file, for easier review.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>strings process.0x80ff88d8.0xc30000.dmp &gt;&gt; dmp_strings.txt
</span></span></code></pre></div><p>Looking through the text file, there was a lot of binary data. Further down I started seeing the function calls that could be used through, then I got to what appeared to be the start of the PE, and where the MZ header would be. This line of text gave the full path and filename <code>C:WINDOWSsystem32driversstr.sys</code>.</p>
<p><img src="03_filename_path.jpg" alt="alt"></p>
<p>Question 4 was to find how many functions were hooked, and by which module, using the SSDT plugin. I am still extremely new to this field, having just started learning, so I did have to web search a little to find out more about SSDT. According to the <a href="https://github.com/volatilityfoundation/volatility/wiki/Command-Reference#ssdt">Volatility Command Reference</a>, I found that the plugin will list functions in the native and GUI System Service Descriptor Tables. These tables are basically an array of addresses to kernel routines for 32-bit operating systems, and for 64-bit operating systems, are relative offsets for the same routines.</p>
<p>So I ran the <code>volatile</code> command to get this SSDT data, using <code>egrep -v '(ntoskrnl|win32k)</code> and outputting this to a text file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python vol.py --profile<span style="color:#f92672">=</span>WinXPSP2x86 -f ~/Desktop/BlackEnergy.vnem ssdt | egrep -v <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">(</span>ntoskrnl|win32k<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>After the process was complete, looking at the text file, I saw two SSDT entries. Both had different addresses, but both had the same number of function calls, and all of them owned by the same HEX value. There were 14 functions hooked, and each owned by module <code>00004A2A</code>.</p>
<p><img src="04_functions.jpg" alt="alt"></p>
<p>I spent far longer with question 5 than I should have done. I was searching for ways of trying to pass the output of <code>ssdt</code> to `modules before I finally realised, it meant just the module that was found in Q4. Too much overthinking the question, and not reading it again, and fully understanding what was being asked.</p>
<p>Now I had figured out I didn’t need to pass anything, I just ran the <code>vol.py</code> command, switching out the plugin for <code>modules</code> and outputting to a new text file, then reading the file with <code>cat</code> and <code>grep</code> to find the <code>00004A2A</code> module.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python vol.py --profile<span style="color:#f92672">=</span>WinXPSP2x86 -f ~/Desktop/BlackEnergy.vnem modules &gt;&gt; ../modules.txt
</span></span><span style="display:flex;"><span>cat ../modules.txt | grep <span style="color:#e6db74">&#34;00004A2A&#34;</span>
</span></span></code></pre></div><p>There was only one entry, listed in columns Offset, Name, Base, Size, and File. Based on this, I could see that the base address was <code>0xff0d1000</code>.</p>
<p><img src="05_modules.jpg" alt="alt"></p>
<p>Almost at the end, now it was to get the hash in question. For this, I needed to get access to a file, so I went back to the volatility command reference repository I had found. This let me know that the <code>moddump</code> plugin will extract a kernel driver to a file, as long as a destination directory was supplied. With using the <code>–base</code> tag too, I could provide the base address and just get the particular driver I was looking for.</p>
<p>I ran the command to dump out the file, then used <code>sha256sum</code> to get the hash value.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python vol.py --profile<span style="color:#f92672">=</span>WinXPSP2x86 -f ~/Desktop/BlackEnergy.vnem moddump --base<span style="color:#f92672">=</span>0xff0d1000 -D ../mod_dump
</span></span><span style="display:flex;"><span>sha256sum ../mod_dump/driver.ff0d1000.sys
</span></span></code></pre></div><p><img src="06_filehash.jpg" alt="alt"></p>
<hr>
<h2 id="challenge-questions-and-answers">Challenge Questions and Answers:</h2>
<ol>
<li>Which process most likely contains injected code, providing its name, PID, and memory address? (Format: Name, PID, Address): <code>svchost.exe, 856, 0xc30000</code></li>
<li>What dump file in the malfind output directory corresponds to the memory address identified for code injection? (Format: Output File Name): <code>process.0x80ff88d8.0xc30000.dmp</code></li>
<li>Which full filename path is referenced in the strings output of the memory section identified by malfind as containing a portable executable (PE32/MZ header)? (Format: Filename Path): <code>C:\WINDOWS\system32\drivers\str.sys</code></li>
<li>How many functions were hooked and by which module after running the ssdt plugin and filtering out legitimate SSDT entries using egrep -v ‘(ntoskrnl|win32k)’? (Format: XX, Module): <code>14, 00004A2A</code></li>
<li>Using the modules (or modscan) plugin to identify the hooking driver from the ssdt output, what is the base address for the module found in Q4? (Format: Base Address): <code>0xff0d1000</code></li>
<li>What is the hash for the malicious driver from the virtual memory image? (Format: SHA256): <code>12b0407d9298e1a7154f5196db4a716052ca3acc70becf2d5489efd35f6c6ec8</code></li>
</ol>
<hr>
<h2 id="references">References:</h2>
<ul>
<li><a href="https://blueteamlabs.online/">https://blueteamlabs.online/</a></li>
<li><a href="https://www.securityblue.team/">https://www.securityblue.team/</a></li>
<li><a href="https://github.com/volatilityfoundation/volatility">https://github.com/volatilityfoundation/volatility</a></li>
<li><a href="https://www.fileformat.info/format/exe/corion-mz.htm">https://www.fileformat.info/format/exe/corion-mz.htm</a></li>
<li><a href="https://github.com/volatilityfoundation/volatility/wiki/Command-Reference#ssdt">https://github.com/volatilityfoundation/volatility/wiki/Command-Reference#ssdt</a></li>
<li><a href="https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/glimpse-into-ssdt-in-windows-x64-kernel">https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/glimpse-into-ssdt-in-windows-x64-kernel</a></li>
</ul>

    </div>
</div>

    </main>
    <footer class="bg-light text-center text-dark py-4 mt-auto">
  <div class="container">
    <div class="mb-3">
      <a href="https://www.linkedin.com/in/emma-du-maurier" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn Profile" class="text-dark mx-2">
        <i class="bi bi-linkedin" style="font-size: 1.5rem;"></i>
      </a>
      <a href="https://github.com/e-duMaurier" target="_blank" rel="noopener noreferrer" aria-label="GitHub Profile" class="text-dark mx-2">
        <i class="bi bi-github" style="font-size: 1.5rem;"></i>
      </a>
      <a href="https://gitlab.com/Dumaurier" target="_blank" rel="noopener noreferrer" aria-label="GitLab Profile" class="text-dark mx-2">
        <i class="bi bi-gitlab" style="font-size: 1.5rem;"></i>
      </a>
    </div>
    <div>
      &copy; Duma Labs 2025
    </div>
  </div>
</footer>

    
        <script src="../../../js/bootstrap.bundle.min.js"></script>
    
</body>
</html>
